{% extends "base.html" %}

{% macro make_label(status_class, status_str) -%}
    {% if status_class %}
        {% set span_cls = ('label', status_class)|join('-') %}
    {% else %}
        {% set span_cls = '' %}
    {% endif %}
    <span class="label {{ span_cls }}">{{ status_str }}</span>
{%- endmacro %}

{% macro make_thead(from_or_to) -%}
    <thead><tr>
        <th>Date</th>
        <th>Status</th>
        <th>Title</th>
        <th>Author</th>
        <th>{{ from_or_to }}</th>
        <th class="pull-right">Available Operations</th>
    </tr></thead>
{%- endmacro %}

{% macro make_pde_trivial(pd_entity, username) -%}
    <td>{{ pd_entity.dispatch_date }}</td>
    <td>{{ make_label(pd_entity.status_class,
                      pd_entity.status_str) }}</td>
    <td>{{ pd_entity.paper.title }}</td>
    <td>{{ pd_entity.paper.author }}</td>
    <td>{{ username }}</td>
{%- endmacro %}

{% macro make_active_class(should_active) -%}
    {% if should_active %}
        active
    {% endif %}
{%- endmacro %}

{% macro make_tab_active_to() -%}
    {{ make_active_class(pd_entities_to) }}
{%- endmacro  %}

{% macro make_tab_active_from() -%}
    {{ make_active_class(not pd_entities_to and pd_entities_from) }}
{%- endmacro  %}

{% macro make_button(text, action, btn_class, _id, additional_fields=[], method="'post'", id_name="'pde_id'") -%}
    <button type="button" class="btn btn-small {{ btn_class }}"
            onclick="proceed({{ _id }}, '{{ url_for(action) }}', {{ additional_fields }}, {{ method }}, {{ id_name }});">
        {{ text }}
    </button>
{%- endmacro %}


{% block head_content %}
    {{ super() }}

{% endblock %}

{% block body_content %}
    {{ super() }}
    <div class="container">
        <ul class="nav nav-tabs" id="tabs">
            <li class="{{ make_tab_active_to() }}">
                <a href="#received" data-toggle="tab"><i class="icon-inbox"></i> Received</a>
            </li>
            <li class="{{ make_tab_active_from() }}">
                <a href="#forwarded" data-toggle="tab"><i class="icon-share"></i> Forwarded</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane {{ make_tab_active_to() }}" id="received">
                {% if pd_entities_to %}
                    <div class="container"><h3>Papers that are forwarded to you</h3>
                        <table class="table table-hover">
                            {{ make_thead('From') }}
                            <tbody>
                                {% for pd_entity in pd_entities_to %}
                                    {% if not pd_entity.forward_status %}
                                        <tr>
                                            {{ make_pde_trivial(pd_entity,
                                                                pd_entity.from_user.username) }}
                                            <td>
                                                {% if pd_entity.status_str == 'Not Started' %}
                                                    {% set read_btn_text = 'Mark as reading' %}
                                                    {% set read_btn_class = 'btn-warning' %}
                                                {% elif pd_entity.status_str == 'Reading' %}
                                                    {% set read_btn_text = 'Mark as finished' %}
                                                    {% set read_btn_class = 'btn-success' %}
                                                {% else %}
                                                    {% set read_btn_text = '' %}
                                                    {% set read_btn_class = '' %}
                                                {% endif %}
                                                <div class="pull-right">
                                                    <div class="btn-group">
                                                        {% if read_btn_text %}
                                                        {{ make_button(read_btn_text, 'read_paper',
                                                                       read_btn_class, pd_entity._id) }}
                                                        {% endif %}
                                                        {{ make_button('Download', 'download_paper',
                                                                       '', pd_entity.paper._id, [],
                                                                       "'get'", "'paper_id'") }}
                                                        <button type="button" href="#forward-dialog"
                                                                role="button" class="btn btn-small"
                                                                data-toggle="modal">
                                                            Forward to
                                                        </button>
                                                        {{ make_button('Refuse', 'withdraw_dispatch',
                                                                       'btn-danger', pd_entity._id,
                                                                       {'status': 'refuse'}) }}
                                                    </div>
                                                    {% import "modals.html" as modals %}
                                                    {{ modals.make_forward_dialog(forward_form, pd_entity._id) }}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="hero-unit">
                        <p class="lead">No paper-receiving record so far :)</p>
                    </div>
                {% endif %}
            </div>

            <div class="tab-pane {{ make_tab_active_from() }}" id="forwarded">
                {% if pd_entities_from %}
                <div class="container"><h3>Papers that you forward to others</h3>
                    <table class="table table-hover">
                        {{ make_thead('To') }}
                        <tbody>
                        {% for pd_entity in pd_entities_from %}
                            {% if pd_entity.forward_status %}
                                {% set tr_class = 'error' %}
                            {% else %}
                                {% set tr_class = '' %}
                            {% endif %}
                            <tr class="{{ tr_class }}">
                                {{ make_pde_trivial(pd_entity,
                                                    pd_entity.to_user.username) }}
                                <td>
                                    <div class="pull-right btn-group">
                                        {% if tr_class %}
                                            {% set buttons = [('redispatch', 'Redispatch', 'btn-info', [])] %}
                                            {{ make_button('Redispatch', 'redispatch', 'btn-info', pd_entity._id) }}
                                        {% else %}
                                            {% if not pd_entity.status_str == 'Already Read' %}
                                                {{ make_button('Hasten this dispatch', 'hasten_dispatch',
                                                               '', pd_entity._id) }}
                                            {% endif %}
                                            {{ make_button('Withdraw', 'withdraw_dispatch', 'btn-danger', pd_entity._id,
                                                           "{'status': 'withdraw'}") }}
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="hero-unit">
                        <p class="lead">No paper-forwarding record so far :)</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block bootstrap_js_bottom %}
    {{ super() }}

    <script type="text/javascript">

        $('#tabs').find('a').click(function (e) {
            e.preventDefault();
            $(this).tab('show');
            $(this).find('i').addClass('icon-white');
        });

        $('a.checkbox-anchor').click(function (e) {
            var checkbox = $('#' + $(this).attr('id').substring(1));
            var i = $('#i' + $(this).attr('id').substring(1));

            checkbox.attr('checked', !checkbox.attr('checked'));
            if (checkbox.attr('checked')) {
                i.removeClass('icon-remove-sign');
                i.addClass('icon-ok-sign');
            } else {
                i.removeClass('icon-ok-sign');
                i.addClass('icon-remove-sign');
            }
        });

        var proceed = function (_id, action, additional_fields, method, id_name) {
            var form = document.createElement('form');
            form.setAttribute('method', method);
            form.setAttribute('action', action);
            form.style.display = 'hidden';
            document.body.appendChild(form);

            var create_field = function (name, value) {
                var _f = document.createElement('input');
                _f.setAttribute('type', 'hidden');
                _f.setAttribute('name', name);
                _f.setAttribute('value', value);
                form.appendChild(_f);
            };

            create_field(id_name, _id);

            for (var field in additional_fields) {
                create_field(field, additional_fields[field]);
            }

            form.submit();
        }
    </script>
{% endblock %}


